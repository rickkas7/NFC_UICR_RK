<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NFC_UICR_RK: NFC_UICR_RK</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">NFC_UICR_RK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title"><a class="el" href="class_n_f_c___u_i_c_r___r_k.html" title="Class for updating the nRF52840 UICR bytes to disable NFC.">NFC_UICR_RK</a> </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__r_e_a_d_m_e"></a> <em>Library for manipulating the NFC settings in the UICR bytes on nRF52840 (Gen 3) devices.</em></p>
<p>Particle Gen 3 devices (nRF52840 MCU) have the capability of supporting NFC tag mode.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Device   </th><th class="markdownTableHeadLeft">Platform   </th><th class="markdownTableHeadCenter">NFC Enabled   </th><th class="markdownTableHeadCenter">NFC Disabled    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Argon   </td><td class="markdownTableBodyLeft"><code>argon</code>   </td><td class="markdownTableBodyCenter">x   </td><td class="markdownTableBodyCenter"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">Boron   </td><td class="markdownTableBodyLeft"><code>boron</code>   </td><td class="markdownTableBodyCenter">x   </td><td class="markdownTableBodyCenter"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">B-SoM   </td><td class="markdownTableBodyLeft"><code>bsom</code>, <code>b5som</code>   </td><td class="markdownTableBodyCenter">x   </td><td class="markdownTableBodyCenter"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">E404X   </td><td class="markdownTableBodyLeft"><code>esomx</code>   </td><td class="markdownTableBodyCenter"></td><td class="markdownTableBodyCenter">x    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Electron 2   </td><td class="markdownTableBodyLeft"><code>electron2</code>   </td><td class="markdownTableBodyCenter">x   </td><td class="markdownTableBodyCenter"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">Monitor One   </td><td class="markdownTableBodyLeft"><code>tracker</code>   </td><td class="markdownTableBodyCenter"></td><td class="markdownTableBodyCenter">x    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Tracker One   </td><td class="markdownTableBodyLeft"><code>tracker</code>   </td><td class="markdownTableBodyCenter">x   </td><td class="markdownTableBodyCenter"></td></tr>
</table>
<p>The two devices that have NFC disabled from the factory (E-SoM and Monitor One) have it disabled because the pins are needed for additional GPIO.</p>
<p>You also have the ability to do this on devices that have it enabled from the factory. Reusing NFC pins as GPIO really only makes sense on the B-SoM because the NFC pins are included on M.2 connector. On the Argon, Boron, and Electron 2 the NFC pins are only available on a U.FL connector.</p>
<ul>
<li>Github: <a href="https://github.com/rickkas7/NFC_UICR_RK">https://github.com/rickkas7/NFC_UICR_RK</a></li>
<li>License: MIT</li>
<li>Full browsable API documentation available <a href="https://rickkas7.github.io/NFC_UICR_RK/index.html">here</a> as well as in the docs directory</li>
</ul>
<h1>Why is this process needed?</h1>
<p>There's a diode that kicks in when the voltage differential between NFC1 and NFC2 is greater than 2.0V. This is designed to protect the MCU from induced voltage from the NFC coils, but obviously would have bad side effects if using as GPIO.</p>
<p>This protection diode can be disabled by setting a register in the the UICR bytes (nRF52 configuration data). These are persistent and will not be reset by flashing application firmware, Device OS, bootloader, or SoftDevice.</p>
<p>Normally you would change the UICR bytes using a SWD/JTAG programmer, but you can also do it from application firmware. One important caveat is that the MCU must be reset after updating the UICR bytes.</p>
<p>You can only set the UICR byte bits from 1 to 0 in application firmware or by SWD! In order to set a 0 value (NFC disabled) back to 1 (NFC enabled), you need to chip erase the device which reset the UICR back to 1 values. It will also erase the bootloader, soft devies, Device OS, and application firmware, and other UICR settings.</p>
<p>Device Restore USB does not affect the UICR bytes.</p>
<p>The Device Restore JTAG .hex files for platforms other than Tracker include the default UICR bytes.</p>
<h1>Using SWD/JTAG</h1>
<h2>SWD programming using hex files</h2>
<p>Included in this Github is the file <code>uicr_nfc_disable.hex</code></p>
<p>You can flash this using a SWD/JTAG programmer to update the settings. Reset the device after updating.</p>
<p>If you are using a CMSIS/DAP debugger you should be able to drag and drop <code>uicr_nfc_disable.hex</code> on the debugger DAPLINK volume.</p>
<p>If you are using the Segger J/LINK with nrfjprog you might use a command like:</p>
<div class="fragment"><div class="line">nfrjprog -f NRF52 --program uicr_nfc_disable.hex</div>
</div><!-- fragment --><h2>Restoring UICR bytes</h2>
<p>To restore the UICR bytes:</p>
<div class="fragment"><div class="line">nfrjprog -f NRF52 --program uicr.hex --chiperase</div>
<div class="line">nfrjprog -f NRF52 --program device-restore.hex</div>
</div><!-- fragment --><p>You cannot restore UICR bytes with a CMSIS/DAP debugger drag-and-drop.</p>
<p>The OpenOCD <code>nrf5 mass_erase</code> option can be used, along with the the device restore JTAG .hex file.</p>
<h2>SWD programming manually</h2>
<p>The NFC function is at offset 0x20C. The default value is enabled (0xffffffff) and to disable NFC, set bit 0 to 0, so 0xfffffffe. There's more information in the <a href="https://infocenter.nordicsemi.com/index.jsp?topic=%2Fcom.nordic.infocenter.nrf52832.ps.v1.1%2Fuicr.html">Nordic UICR documentation</a>.</p>
<p>The offset is relative to the UICR base address 0x10001000, but the exact way to set it depends on which tool you are using.</p>
<p>You cannot set single UICR bits back to 1; you must chip erase and flash the entire device image to restore NFC mode.</p>
<h1>Using this library</h1>
<p>If you cannot use SWD to programmer during your device setup and initial programming, it is possible to do it from user firmware. This could be from the actual user firmware you will be using, or a setup or test firmware build.</p>
<p>One important caveat: The device must be reset after updating the UICR bytes. This is very fast and can be done from software so it doesn't require user intervention, but it does need to occur.</p>
<p>For example, you might include this in your firmware:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;NFC_UICR_RK.h&quot;</span></div>
<div class="line"> </div>
<div class="line">SYSTEM_MODE(SEMI_AUTOMATIC);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// System thread defaults to on in 6.2.0 and later and this line is not required</span></div>
<div class="line"><span class="preprocessor">#ifndef SYSTEM_VERSION_v620</span></div>
<div class="line">SYSTEM_THREAD(ENABLED);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">SerialLogHandler logHandler(LOG_LEVEL_INFO);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> setup() {</div>
<div class="line">    <span class="comment">// Checks the NFC status in the UICR bytes and disables it if enabled.</span></div>
<div class="line">    <span class="comment">// You should use this with SYSTEM_THREAD(ENABLED) and SEMI_AUTOMATIC mode so the device</span></div>
<div class="line">    <span class="comment">// won&#39;t attempt to connect to the cloud before doing this!</span></div>
<div class="line">    <a class="code hl_function" href="class_n_f_c___u_i_c_r___r_k.html#a6c45e41067a9cf6698e7dc454bd3a385">NFC_UICR_RK::disableNFC</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Can be any time after disableNFC() returns</span></div>
<div class="line">    Particle.connect();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> loop() {</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="ttc" id="aclass_n_f_c___u_i_c_r___r_k_html_a6c45e41067a9cf6698e7dc454bd3a385"><div class="ttname"><a href="class_n_f_c___u_i_c_r___r_k.html#a6c45e41067a9cf6698e7dc454bd3a385">NFC_UICR_RK::disableNFC</a></div><div class="ttdeci">static void disableNFC()</div><div class="ttdoc">Disable NFC it was previously enabled.</div><div class="ttdef"><b>Definition</b> NFC_UICR_RK.cpp:57</div></div>
</div><!-- fragment --><p>Of note:</p>
<ul>
<li>Be sure you use <code>SYSTEM_MODE(SEMI_AUTOMATIC)</code> so the device will not attempt to connect to the cloud before checking the UICR bytes.</li>
<li><code>SYSTEM_THREAD(ENABLED)</code> is always recommended in all firmware.</li>
<li>Add a call to <code><a class="el" href="class_n_f_c___u_i_c_r___r_k.html#a6c45e41067a9cf6698e7dc454bd3a385" title="Disable NFC it was previously enabled.">NFC_UICR_RK::disableNFC()</a></code> at the beginning of <code>setup()</code>.</li>
<li>Do not enable BLE before updating the UICR bytes.</li>
<li>It's safe to call <code>Particle.connect()</code> and time after checking the UICR bytes.</li>
</ul>
<p>If the UICR bytes indicate that NFC is already disabled, the function returns immediately.</p>
<p>If the UICR bytes need updating, they will be updated and the device reset, so the lines after <code><a class="el" href="class_n_f_c___u_i_c_r___r_k.html#a6c45e41067a9cf6698e7dc454bd3a385" title="Disable NFC it was previously enabled.">NFC_UICR_RK::disableNFC()</a></code> will not be executed until after reset.</p>
<p>One potential issue is that if the updating failed, the device would enter a rolling reboot and would never fully boot. This is unlikely, but cannot be ruled out as a remote possibility. Once the UICR bytes are set once, this should never be an issue.</p>
<p>Note that you cannot turn NFC back on without chip erasing the device using a SWD/JTAG programmer, so make sure you don't turn it off if you may need to use it again and you don't have the appropriate SWD/JTAG programming hardware! </p>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"/>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
